<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    <t t-name="tug_barcode_custom.MainTemplate">
        <div class="o_package_mover_app h-100 d-flex flex-column bg-200">
            
            <!-- Header -->
            <div class="o_barcode_header p-2 bg-white shadow-sm d-flex justify-content-between align-items-center z-index-1">
                <div class="d-flex align-items-center">
                    <button t-if="state.mode === 'detail'" class="btn btn-secondary me-2" t-on-click="backToList">
                        <i class="fa fa-chevron-left"/> Back
                    </button>
                    <h4 class="m-0">Tug Package Mover</h4>
                </div>
                <span class="badge bg-primary" t-esc="state.scannedPackages.length + ' Pkg(s)'"/>
            </div>

            <!-- Content Area -->
            <div class="flex-grow-1 overflow-auto p-3 mb-5">
                
                <!-- LIST MODE -->
                <div t-if="state.mode === 'list'">
                    
                    <!-- Empty State / Scan Prompt -->
                    <div t-if="state.scannedPackages.length === 0" class="d-flex flex-column align-items-center justify-content-center h-50 text-muted mt-5">
                        <t t-if="!state.waitingForSourceLocation">
                            <i class="fa fa-barcode fa-5x mb-3"/>
                            <h3>Scan a Package</h3>
                            <p>Scan packages one by one...</p>
                            <div class="my-3 text-uppercase fw-bold">OR</div>
                            <!-- Button to Trigger Source Location Scan -->
                            <button class="btn btn-outline-primary btn-lg" t-on-click="triggerLoadFromLocation">
                                <i class="fa fa-map-marker"/> Scan Location to Load All
                            </button>
                        </t>
                        <t t-else="">
                            <i class="fa fa-spinner fa-spin fa-5x mb-3 text-primary"/>
                            <h3 class="text-primary">Scanning Source...</h3>
                            <p>Scan a location barcode to load all packages inside.</p>
                            
                            <!-- Manual Input for Source Location -->
                            <div class="mt-3 w-75">
                                <input type="text" class="form-control form-control-lg border-primary" 
                                       placeholder="Type Source Location..." 
                                       t-on-keydown="onManualLocationKeydown"
                                       autofocus="autofocus"/>
                            </div>
                            
                            <button class="btn btn-secondary mt-3" t-on-click="cancelMove">
                                Cancel
                            </button>
                        </t>
                    </div>

                    <!-- List Content -->
                    <div class="list-group" t-if="state.scannedPackages.length > 0">
                        <t t-foreach="state.scannedPackages" t-as="pkg" t-key="pkg.id">
                            <div class="list-group-item list-group-item-action d-flex flex-column p-3 mb-2 shadow-sm border-0 rounded">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="flex-grow-1" t-on-click="() => this.selectPackage(pkg)" style="cursor: pointer;">
                                        <h5 class="mb-0 text-primary"><i class="fa fa-box"/> <t t-esc="pkg.name"/></h5>
                                        <small class="text-muted"><i class="fa fa-map-marker"/> <t t-esc="pkg.location_name"/></small>
                                    </div>
                                    <button class="btn btn-light text-danger btn-sm" t-on-click.stop="() => this.removePackage(pkg)" title="Remove">
                                        <i class="fa fa-trash"/>
                                    </button>
                                </div>
                                <div class="border-top pt-2 mt-1" t-on-click="() => this.selectPackage(pkg)" style="cursor: pointer;">
                                    <t t-foreach="pkg.contents" t-as="line" t-key="line.product_name">
                                        <div class="d-flex justify-content-between small text-dark">
                                            <span class="text-truncate" style="max-width: 75%;"><t t-esc="line.product_name"/></span>
                                            <span class="fw-bold"><t t-esc="line.quantity"/></span>
                                        </div>
                                    </t>
                                </div>
                            </div>
                        </t>
                        
                        <!-- Allow loading more even if list not empty -->
                        <div class="text-center mt-3 mb-2" t-if="!state.waitingForSourceLocation">
                             <button class="btn btn-outline-secondary" t-on-click="triggerLoadFromLocation">
                                <i class="fa fa-plus-circle"/> Load more from Location
                            </button>
                        </div>
                        <div class="text-center mt-3 mb-2" t-if="state.waitingForSourceLocation">
                             <div class="alert alert-info">
                                <i class="fa fa-spinner fa-spin"/> Scanning Source Location...
                             </div>
                             <div class="w-75 mx-auto">
                                <input type="text" class="form-control" 
                                       placeholder="Type Source Location..." 
                                       t-on-keydown="onManualLocationKeydown"
                                       autofocus="autofocus"/>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- DETAIL MODE -->
                <div t-if="state.mode === 'detail'" class="card shadow-sm border-0">
                    <div class="card-header bg-white border-bottom p-3">
                        <h3 class="m-0 text-primary"><i class="fa fa-box-open"/> <t t-esc="state.activePackage.name"/></h3>
                        <div class="text-muted mt-1">
                            Current: <strong t-esc="state.activePackage.location_name"/>
                        </div>
                    </div>
                    
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th class="ps-3">Product</th>
                                        <th>Qty</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr t-foreach="state.activePackage.contents" t-as="line" t-key="line.product_name">
                                        <td class="ps-3">
                                            <div class="fw-bold"><t t-esc="line.product_name"/></div>
                                            <div t-if="line.lot" class="badge bg-secondary"><t t-esc="line.lot"/></div>
                                        </td>
                                        <td class="align-middle">
                                            <span class="badge bg-info text-dark" style="font-size: 1em;">
                                                <t t-esc="line.quantity"/> <t t-esc="line.uom"/>
                                            </span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card-footer p-3 bg-white">
                        <t t-if="!state.waitingForLocation">
                            <button class="btn btn-primary w-100 py-3 fw-bold text-uppercase" style="font-size: 1.2rem;" t-on-click="triggerMove">
                                <i class="fa fa-truck"/> Move Package
                            </button>
                        </t>
                        <t t-else="">
                            <div class="mb-2">
                                <label class="small text-muted mb-1">Scanner not working?</label>
                                <input type="text" class="form-control form-control-lg border-primary" 
                                       placeholder="Type Location &amp; Enter..." 
                                       t-on-keydown="onManualLocationKeydown"
                                       autofocus="autofocus"/>
                            </div>
                            <button class="btn btn-secondary w-100 py-2" t-on-click="cancelMove">
                                Cancel Move
                            </button>
                        </t>
                    </div>
                </div>

            </div>

            <!-- Footer for LIST MODE (MOVE ALL) -->
            <div t-if="state.mode === 'list' and state.scannedPackages.length > 0" class="p-3 bg-white border-top shadow-lg" style="position: absolute; bottom: 0; width: 100%; z-index: 10;">
                 <t t-if="!state.waitingForLocation and !state.waitingForSourceLocation">
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-danger py-3 fw-bold text-uppercase shadow-sm" style="font-size: 1.2rem; flex: 1;" t-on-click="clearList">
                            <i class="fa fa-times"/> Clear
                        </button>
                        <button class="btn btn-success py-3 fw-bold text-uppercase shadow" style="font-size: 1.2rem; flex: 2;" t-on-click="triggerMoveAll">
                            <i class="fa fa-truck-loading"/> Move All (<t t-esc="state.scannedPackages.length"/>)
                        </button>
                    </div>
                </t>
                <t t-elif="state.waitingForLocation">
                    <div class="mb-2">
                        <label class="small text-muted mb-1">Scanner not working?</label>
                        <input type="text" class="form-control form-control-lg border-success" 
                               placeholder="Type Destination &amp; Enter..." 
                               t-on-keydown="onManualLocationKeydown"
                               autofocus="autofocus"/>
                    </div>
                    <button class="btn btn-secondary w-100 py-2" t-on-click="cancelMove">
                        Cancel Batch Move
                    </button>
                </t>
                 <t t-elif="state.waitingForSourceLocation">
                    <!-- Footer when scanning source but list has items -->
                     <button class="btn btn-secondary w-100 py-2" t-on-click="cancelMove">
                        Cancel Source Scan
                    </button>
                </t>
            </div>

        </div>
    </t>
</templates>